name: Auto-Seal Secrets
on:
  workflow_dispatch: # DÃ©clenchement manuel

permissions:
  contents: write  

jobs:
  seal:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Kubeseal
        run: |
          # Utilisation de la version 0.34.0
          KUBESEAL_VERSION=0.34.0
          wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v${KUBESEAL_VERSION}/kubeseal-${KUBESEAL_VERSION}-linux-amd64.tar.gz
          tar -xvzf kubeseal-${KUBESEAL_VERSION}-linux-amd64.tar.gz kubeseal
          sudo install -m 0755 kubeseal /usr/local/bin/kubeseal

      - name: Generate and Seal Secrets
        env:
          # Mapping des secrets GitHub en variables d'environnement
          D_USER: ${{ secrets.DOCKER_USERNAME }}
          D_PASS: ${{ secrets.DOCKER_PASSWORD }}
          P_USER: ${{ secrets.POSTGRES_USERNAME }}
          P_PASS: ${{ secrets.POSTGRES_PASSWORD }}
          P_DB: ${{ secrets.POSTGRES_DB }}
        run: |
          mkdir -p k8s/01-initialisation/sealed-secrets/
          CERT="k8s/00-infra/certs/pub-sealed-secrets.pem"

          # 1. Secret Docker Hub
          kubectl create secret docker-registry dockerhub-auth-secret \
            --docker-username="$D_USER" \
            --docker-password="$D_PASS" \
            --namespace=rt --dry-run=client -o yaml | \
            kubeseal --cert "$CERT" > k8s/01-initialisation/sealed-secrets/docker-sealed-secret.yaml

          # 2. Secret Postgres
          kubectl create secret generic postgres-secret \
            --from-literal=postgres-user="$P_USER" \
            --from-literal=postgres-password="$P_PASS" \
            --from-literal=postgres-db="$P_DB" \
            --namespace=rt --dry-run=client -o yaml | \
            kubeseal --cert "$CERT" > k8s/01-initialisation/sealed-secrets/postgres-sealed-secret.yaml

      - name: Commit & Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add k8s/01-initialisation/sealed-secrets/*.yaml
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: automated update of sealed secrets" && git push)